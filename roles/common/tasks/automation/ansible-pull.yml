---
# 🛠️ System Setup: Cron jobs for ansibot

# ───────────────────────────────
# 1. Regular System Updates
# ───────────────────────────────
- name: system setup | cron | Quarter-daily nala update & apt upgrade
  ansible.builtin.cron:
    name: "quarter-daily system update"
    user: ansibot
    hour: "*/6"
    minute: 0
    job: >
      /usr/bin/date >> /var/lib/ansibot/Ansi.txt &&
      /usr/bin/sudo /usr/bin/nala update >> /var/lib/ansibot/Ansi.txt 2>&1 &&
      /usr/bin/sudo /usr/bin/apt upgrade -y >> /var/lib/ansibot/Ansi.txt 2>&1 &&
      /usr/bin/sudo /usr/bin/apt autoremove -y >> /var/lib/ansibot/Ansi.txt 2>&1

# ───────────────────────────────
# 2. Configuration Autopull
# ───────────────────────────────
- name: system setup | cron | Ansible autopull setup
  ansible.builtin.cron:
    name: "ansible autopull provision"
    user: ansibot
    minute: 15
    job: >
      /usr/bin/ansible-pull -o
      -U https://github.com/Temhr/Ansi.git
      >> /var/lib/ansibot/AnsiLog.txt 2>&1

# ───────────────────────────────
# 3. Log Management
# ───────────────────────────────
- name: system setup | cron | Weekly Tuesday log archive & reset
  ansible.builtin.cron:
    name: "weekly log archive & cleanup"
    user: ansibot
    weekday: 2        # Tuesday
    hour: 7
    minute: 35
    job: >
      sh -c "cp /var/lib/ansibot/Ansi.txt
      /var/lib/ansibot/log-$(uname -n)-$(date +\%Y-\%m-\%d).txt &&
      rm -f /var/lib/ansibot/Ansi.txt /var/lib/ansibot/AnsiLog.txt"

- name: system setup | cron | Global log rotation (keep 7 days)
  ansible.builtin.cron:
    name: "daily log cleanup"
    user: ansibot
    hour: 0
    minute: 30
    job: >
      find /var/lib/ansibot -maxdepth 1 -type f
      -name "log-*.txt" -mtime +7 -delete

- name: system setup | cron | Monthly log archive (compress before delete)
  ansible.builtin.cron:
    name: "monthly log archive"
    user: ansibot
    weekday: 1         # Monday
    hour: 1
    minute: 0
    job: >
      sh -c "tar -czf /var/lib/ansibot/archive-$(uname -n)-$(date +\%Y-\%m).tar.gz
      /var/lib/ansibot/log-*.txt 2>/dev/null || true"

# ───────────────────────────────
# 4. Service Handling
# ───────────────────────────────
- name: system setup | cron | Ensure cron service is running
  ansible.builtin.systemd_service:
    name: cron
    enabled: true
    state: started

# ───────────────────────────────
# 5. Cleanup on Boot
# ───────────────────────────────
- name: system setup | cron | Cleanup ansible cache on reboot
  ansible.builtin.cron:
    name: "ansible cache refresh at boot"
    user: ansibot
    special_time: reboot
    job: "/bin/rm -rf /var/lib/ansibot/.ansible"
